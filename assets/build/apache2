#!/bin/bash

set -e

cat <<EOF>/etc/apache2/mods-available/fcgid.conf
<IfModule mod_fcgid.c>
	FcgidConnectTimeout 20
	<FilesMatch \.(php|php5)\$>
		AddHandler fcgid-script .php .php5
	</FilesMatch>
	SocketPath /var/lib/apache2/fcgid/sock
	IdleTimeout 3600
	IdleScanInterval 120
	BusyTimeout 300
	BusyScanInterval 120
	ErrorScanInterval 3
	ZombieScanInterval 3
	ProcessLifeTime 30
	SpawnScoreUpLimit 10
	SpawnScore 1
	TerminationScore 2
	MaxProcessCount 5
	DefaultMaxClassProcessCount 2
	DefaultMinClassProcessCount 1
	IPCConnectTimeout 3600
	IPCCommTimeout 3600
	MaxRequestsPerProcess 20
	Passheader AUTHORIZATION
	FcgidMaxRequestLen 8100000
	<Directory "/var/www/fcgid/">
		AllowOverride None
		Options +ExecCGI MultiViews -Indexes
		Order allow,deny
		Allow from all
	</Directory>
</IfModule>
EOF

cat <<EOF >/etc/apache2/sites-available/app
Alias / /app/
<IfModule suexec_module>
	SuexecUserGroup dev dev
</IfModule>

<Directory /app>
	FCGIWrapper /var/www/fcgid/php-fcgi .php
	Options +ExecCGI
	AllowOverride All
</Directory>

EOF

a2enmod ssl rewrite suexec fcgid
a2dissite default
a2ensite app

# configure supervisord to start apache2
cat <<EOF >/etc/supervisor/conf.d/apache2.conf
[program:apache2]
priority = 10
environment = HOME="/var/www"
command = /docker/run/apache2
user = root
autostart = true
autorestart = true
stopsignal = QUIT
stdout_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
stderr_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
EOF

mkdir /var/run/apache2