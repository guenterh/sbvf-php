#!/bin/bash

set -e

cat >/etc/apache2/sites-available/99-app.conf <<EOF
Alias / ${APP_HOME}
DirectoryIndex /index.php index.php
ProxyPassMatch ^/(.*\.php(/.*)?)\$ fcgi://127.0.0.1:9000${APP_HOME}/\$1
EOF

a2enmod ssl rewrite proxy_fcgi
a2ensite 99-app default-ssl

# configure supervisord to start apache2
cat >/etc/supervisor/conf.d/apache2.conf <<EOF
[program:apache2]
priority = 10
environment = HOME="/var/www"
command = /usr/sbin/apache2ctl -DFOREGROUND -k start
redirect_stderr = true
user = root
autostart = true
autorestart = true
stopasgroup = true
stdout_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
stderr_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
EOF
